<!DOCTYPE HTML>
<html>
<head>
    <title>Testing status</title>
    <style>
body{font-family:Arial;font-size:.675em;display:block;position:relative;}
ul{ padding:0;display:block;}
ul li{ margin:0 0 .5em 0;padding:0.4em .8em;font-size:1.2em;list-style: none;cursor:pointer;border:solid silver 1px;border-radius:2px;box-shadow:1px 1px 2px #888; background:#fff;}
ul li .projectName{font-size:1.2em;}
ul li .updateTime{font-size:.8em;color:#333;}
ul li .lastMergeDate{float:right;}
ul li.error{color:red;}
ul li.error .detail{display:none;}
ul .open dl, ul .open.error .detail{display:block;}
dl{display:none;}
dt{margin-top:.5em;background:#f5f5f5;border-radius:2px;padding:0.2em;border:solid silver 1px;}
dt img{box-shadow:1px 1px 2px #000;border-radius:2px;margin:0 .4em;vertical-align:middle;}
dd{margin:0 1em;background:#f0f0f0;padding:.5em;border-bottom-right-radius:5px;border-bottom-left-radius:5px;box-shadow:0px 1px 4px #888;}
body.loading{ background:#ffffee; }
.loading:before{ background:#fee;color:red;content:"Loading";position:fixed;top:2px;right:2px;display:block;padding:.4em;font-size:1.2em; }
    </style>
    <script src="basic-compat.js"></script>
    <script src="stpl.js"></script>
    <script src="D.js"></script>

    <script type="text/stpl" rel="projectName">
        <span class="projectName">{{label}}</span> <span class="updateTime">{{updateTime|fuzzyDate}}</span>{{merges.length?}}<span class="lastMergeDate {{merges.0.at|freshNess}}">{{merges.0.at}}</span>{{?merges.length}}
    </script>
    <script type="text/stpl" rel="projectStatus">
        {{#statuses}}{{error?}}{{>projectStatusError}}{{?error}}{{error!?}}{{>projectStatusOk}}{{?error}}{{/statuses}}
    </script>
    <script type="text/stpl" rel="projectStatusError">
        <li class="error">{{>projectName}}<div class="detail">Error: {{error}}</div></li>
    </script>
    <script type="text/stpl" rel="projectStatusOk">
        <li>{{>projectName}}<dl>{{#merges}}<dt>merge by <img src="{{gravatar}}" alt="{{mail}}" />{{by}} at {{at}}</dt><dd class="branches">{{branches|listBranch}}</dd>{{/merges}}</dl>{{#merges.branches:test}}{{name}}{{/merges.branches}}</li>
    </script>
</head>
<body>
<h1>Testing status</h1>
<ul id="projects"></ul>
<button id="refreshStatuses">refresh Statuses</button>
<button id="reloadConfig">Reload config</button>
<script type="text/javascript">
    function startLoading(){ $('body').addClass('loading');};
    function stopLoading(){ $('body').removeClass('loading');};
    var api={
        request:function(url,json){
            var d = D()
                ,xhr=new XMLHttpRequest()
            ;
            xhr.onreadystatechange = function(){
                if (xhr.readyState == 4) {
                    var result, error = false
                    if ((xhr.status >= 200 && xhr.status < 300) || xhr.status == 304 || (xhr.status == 0 && protocol == 'file:')) {
                      d.resolve(json ? JSON.parse(xhr.responseText) : xhr.responseText);
                    } else {
                      d.reject(xhr.status || 'aborted')
                    }
                }
            };
            startLoading();
            xhr.open('GET', url, true);
            xhr.send();
            d.promise.then(stopLoading,stopLoading);
            return d.promise;
        }
        ,updateConfig:function(){ return this.request('/updateConfig',false); }
        ,getStatuses:function(forceRefresh){ return this.request('/getStatuses'+(forceRefresh?'/reload':''),true); }
        ,updateStatus:function(repoName){ return this.request('/getStatus/'+repoName,true); }
    }
    //-- template system bindings
    $.fn.stpl = function(tplName,data){ $(this).html(stpl(tplName,data)); }
    stpl.registerFilter('listBranch',function(branches){
        var b=[];$.each(branches,function(k,v){ return b.push(v.name);});
        return branches.length ? '<span class="branch">'+b.join('</span>, <span class="branch">')+'</span>' : '';
    });
    stpl.registerFilter('fuzzyDate',function(timeStamp){
        var d = new Date();
        d.setTime(timeStamp);
        return d.toString();
    });
    stpl.registerFilter('freshNess',function(date){
        return (new Date(date)).toString();
    });
    //encapsulate status refresh to sort the results
    function refreshStatuses(refresh){
        return api.getStatuses(refresh)
            .success(function(statuses){
                var statusesArray=[];
                $.each(statuses,function(k,v){ statusesArray.push(v);});
                [].sort.call(statusesArray,function(a,b){return a.label.toLowerCase()>b.label.toLowerCase()?1:-1});
                $('#projects').html('').stpl('projectStatus', {statuses:statusesArray})
            })
            .rethrow()
        ;
    }
    function reload(){ window.location.relaod();}
    $(function(){
       refreshStatuses();
        $('#projects').on('click','li, span.projectName',function(e){
            var li = $(this);
            li.is('li') && li.toggleClass('open') || li.closest('li').toggleClass('open');
        });
        $('#reloadConfig').on('click',function(){
            api.updateConfig()
                .then(reload)
                .rethrow();
        });
        $('#refreshStatuses').on('click',function(){
            refreshStatuses(true).success(reload);
        });
    });
</script>
</body>
</html>
